# Существующие проблемы

## Бизнес проблемы

* **Клиенты** жалуются менеджерам по продажам, что они **не получили заказ** и над их изделием работают уже несколько месяцев, хотя обещали закончить за три недели. 
* Компания открыла свой API, который MES использует для расчёта стоимости изделия что привело к **увеличению просроченных заказов**.
* **Появились жалобы со стороны пользователей API**. Представители компаний ежедневно сообщают, что не получили свои заказы.
* **Участились жалобы от операторов**: когда они заходят на первую страницу MES, система долго прогружается. Операторам важно видеть самые новые заказы, потому что от этого зависит их вознаграждение, — кто взял заказ, тот и получит оплату.
* Через месяц после открытия API **компания потеряла уже несколько крупных контрактов из-за проблем с заказами**.
* **Растет недовольство клиентов онлайн-магазина** (B2C). 


## Управленческие

* В компании не планируют технические изменения или адаптацию под будущий профиль нагрузки
* В компании отсутствует нагрузочное тестирование
* Высокий bus factor на QA и DevOps
* Имеется вероятность что мы имеем несбалансированные команды, получается 1QA на 4 разработчиков, это снижает качество тестирования
* Нет SLA и контроля заказов, их статуса

## Технические

* Система вероятно не справляется с нагрузкой, так как проблемы появились при ее увеличении (требуется проверить гипотезу)
* Отсутствует балансировка, что может вызывать проблемы производительности (требуется исследование, мониторинг)
* Отсутствуют механизмы и инструменты для выявления проблем  
* Ручное развертывание может приводить к проблемам в работе и простоям бизнеса
* Медленная загрузка первой страницы MES

# Потенциальные проблемы

* Текущее техническое решение сложно масштабировать, система можно сказать что она выполнена по архитектуре монолита, каждый сервис имеет по одному инстансу
* Отсутствует мониторинг, нам трудно выявлять проблемные места
* Отсутствует логирование и трасировка для выявления проблем, что вызывает сложности в разборе инцидентов
* Отсутствует балансировка нагрузки, как следствие, вероятность перегрузки и отказа системы очень высока
* Статусы заказа не транслируются потребителям сервиса, это может снижать лояльность, и приводить к потере клиентов


# Инициативы, которые необходимы для устранения нежелательных ситуаций (в порядке приоритета)

## 1. Проверка гипотез. Создание системы трассировки, логирования и мониторинга

### Мотив

Нам требуется экономически эффективно выполнять работы, не оптимизировать все попало, а в самом начале выявить проблемы, иметь возможность разобрать инцидент. Ресурсы разработки как правило самые дорогие, вероятность возникновения проблем при доработке монолита также высока, по этому следует действовать очень аккуратно и обдуманно. Само по себе, монолитное техническое решение не является плохим, но оно может не отвечать новым требованиям - это нам и требуется проанализировать.

### Решение

1. Внедрить систему мониторинга
2. Внедрить систему трассировки
3. Внедрить логирование

## 2. Контроль качества и раннее выявление проблем

### Мотив

На текущий момент нам требуется стабилизировать ситуацию в контексте бизнес проблем, это позволит получать стабильное финансирование наших будущих изменений. Мы увеличим количество сценариев тестирования, и будет пробовать создавать необходимую нагрузку. 

### Решение

1. Нанять еще 2 QA (текущий пусть идет на создание автотестов и станет лидом, и 2 ручника)
2. Реализовать все необходимые тесты силами QA и остальной команды, а также настроить их регулярный запуск (для остальной команды будет некоторый период простоя, на время анализа, по этому мы можем рационально их загрузить реализацие тестов) 
3. Сформировать требования и практики для команды разработки направленные на повышение качества (книга практик)

## 3. Произвести комплексный анализ технического решения с разбором инцедентов

### Мотив

Разработка и внедрение инструментов не означает что мы как то определили проблему, но у нас появилась возможность их выявлять и принимать взвешанные решения. Нужно взять время на наблюдение и анализ работы системы. 

### Решение

1. Определить интервал времени, за который мы проведем наблюдение
2. Сформировать отчетность, статистику, постараться сделать выводы
3. Предложить верхнеуровнево техническое решение для увеличения лояльности руководства и повышения доверия - это позволит в будущем внедрять сложные решения избегая микроменджмент со стороны руководства
4. За этот период также требуется пристально разбирать каждый ицедент, без санкций для специалистов, вовлечение команды должно быть максимальным

--

Для дальнейших шагов мы делаем следующие допущения по итогам 4 шага:

Легенда: Ситуаци несколько стабилизировалась, негатив спал, но напряженность осталась, руководству был представлен список проблем, и оно согласно на дальнейшие инвестиции в архитектуру и разработку, при условии что текущее продолжит функционировать должным образом.
Проблемы которые мы выявили:

1. Скорость расчетов MES линейно уменьшается, в зависимости от количества запросов, увеличивается и время ответа даже на простые запросы кратно согласно RSP
2. При увеличении количества заказов, очередь RabbitMq начинает расти с увеличивающейся скоростью
3. В моменты возникновения инцедентов пиковая загрузка процессора на серверах MES = 100%
4. Логи MES показали увеличение времени выполнения функции расчета стоимости как зависимость от ресурсов
5. Трасировка показала отдельные функции MES выполняющиеся очень долго, и вызывающие значительное потребление ресурсов по отношению к всей системе
6. Явных проблем с CRM и Веб порталом не обнаружено 

--
## 4. Снижение давления на бизнес из за технических проблем

### Мотив

Бизнес не перестает функционировать, и если мы ничего не сделаем в моменте то у нас не будет ресурсов продолжать работы, бизнес будет нести издержки, финансовые потери. По этой причине нам нужны быстрые решения что бы просуществовать еще немного.

### Решение

1. Увеличить мощность сервера на котором развернута MES (ЦПУ, ОЗУ)
2. Увеличить мощность на сервере где развернут RabbitMq (ЦПУ, ОЗУ, объем ПЗУ, и проконтролировать скорость сетевого соединения >1Гбит/с)
3. Мониторинг и отработка инцедентов
4. Более тщательное тестирование под нагрузкой
5. Команда разработки помогает с автотестами + реализует технические решения для уменьшения нагрузки (прим. пэйджинация на главной странице, Lazy Loading, и т.д.)
6. Добавим кэширование на границе веб сервера и бэкенда, Redis, возможно он нам потребуется в будущем, в данный момент это недорогая и быстрая возможность снизить  нагрузку на систему в целом

## 4. Проектирование и защита архитектуры будущего технического решения

### Мотив

Если мы правы то в моменте мы повысили стабильность системы, и у нас появилась возможность срочно приступать к проектированию архитектуры.

### Решение

1. Нам нужны профили нагрузки (считаем что они у нас есть, исходя из этого будем планировать ресурсы)
2. Так как мы выявили основную проблему в MES, и даже нашли узкое место нам потребуется вынести этот функционал в микросервис, так будет проще масштабировать
3. Добавим ACL для внедрения наших изменений, что бы не прерывать работу компании
4. Реализуем паттерн Circuit Breaker для повышения стабильности, наша система не должна упасть из за "отдельных недоразумений"
5. Реализуем паттерн Rate Limiting для защиты от перегрузки системы

## 5. Реализация 

### Мотив

Мы подготовили решение, и защитили, настало время для его реализации

### Решение

1. Объявить о начале работ
2. Познакомить команду с решением (в какой то степени она должна быть уже знакома и до этого)
3. Обучить команду и оказывать необходимую поддержку, участвовать в техническом ревью
4. Реализовать книгу практик разработки для команды

## 6. Мониторинг и анализ работы системы

### Мотив

Мы выполнили все необходимые действия для поддержания стабильности и развития бизнеса, теперь нам требуется проверить, подтвердить наши ожидания, и предоставить руководству отчет, это с одной стороны повысит лояльность руководства, с другой у нас будут неоспоримые данные которве я надеюсь подтверждают верность нашего технического решения 

### Решение

1. Нужно подготовить список инцедентов в выбранном периоде после внедрения всей системы, можно сравнить с подобным списком полученом на шаге 3
2. Требуется получить статистику от мониторинга в выбранном периоде после внедрения всей системы, можно сравнить с подобным списком полученом на шаге 3
3. Предоставить данные руководству, сформировать список рекомендаций по техническому решению, масштабированию, и возможных проблем + способы решения

## 7. Оптимизация процессов CI/CD

### Мотив

Так как у нас предстоит множество работы работы над архитектурой и сервисам в контексте CI/CD есть смысл в принципе сделать все как нужно, это будет дешевле, команда DevOps будет на подъеме, нужно пользоваться, ведь это принесет не просто экономию в реализации, но и профит для бизнеса на перспективу в целом.

### Решение

1. Повсеместное внедрение механизмов автоматического развертывания повысить стабильность и скорость доставки
2. Внедрение и автозапуск тестов (интеграционные и e2e) повысит качество и в перспективе позволит сэкономить как на QA так и за счет избежания финансовых потерь, из за наличия ошибок

## 8. План работ для команды на перспективу

### Мотив

Главная наша задача решена, система стабильна, но мы знаем что она далека от идеала, по этому можем предложить бизнесу и команде ряд инициатив 

### Решение

1. Удалить ACL кажется более он нам не потребуется в текущем контексте, а так, мы сэкономим ресурсы
4. Добавить сервисы уведомлений, и настроить уведомления о срыве SLA по статусам заказов
5. Разработать и зафиксировать необходимые SLA
6. Предоставить пользователям механизм просмотра статуса заказа


# Итого 

## На выходе мы должны получить через пол года

1. Не раздутый штат специалистов
2. Сэкономленные ресурсы, за счет того что мы не стали разбивать всю систему на микросервисы
3. Стабильная работа системы и возможности масштабирования
4. Механизмы мониторинга и отработки инцедентов
5. Довольных клиентов

## Самые ценные три инициативы из всего списка

1. Внедрить механизм обнаружения проблем (трасировка, логи, мониторинг)
2. Добавить ресурсы железу - это позволит просуществовать еще какое то время, и относительно дешево 
3. Выделить критичные функции в микросервис, и настроить их отдельное от остальной системы горизонтальное масштабирование
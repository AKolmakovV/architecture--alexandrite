# Мотивация

Разработка, очень дорогой процесс, и не редки случаи когда принятие неверных решений приводили к значительным финансовым потерям, или краху всего бизнеса. В нашем случа эти риски также очень значительны, ведь "Александрит" не имеет других механизмов сбыта продукции и работе с клиентами, кроме текущего технического решения, а значит простои недопустимы, ровно как и перерасход средств как на разработку, так и на сопровождение, ведь от этого напрямую зависит маржинальность бизнеса. По этой причине, нам следует принимать очень аккуратные и взвешанные решения, не пытаться оптимизировать все и сразу, отрабатывать инцеденты, и делать правильные выводы. Для этих целей нам и потребуется реализовать мониторинг, найти истинные причины проблем, контролировать работу системы на каждом этапе, принимать превентивные меры для избежания проблем в будущем, или решать уже возникшие проблемы.
 

# Выбор подхода к мониторингу

Для мониторинга мы будем использовать RED подход для всей системы, наши сервисы управляются запросами, и количество проблем в задании напрямую зависит от количества запросов.

Метрики:

    Requests Rate — частота запросов,
    Errors — ошибки,
    Duration — длительность.

Мы также будем использовать USE, для микросервисв. Смысл предстоящей оптимизации в том что бы выделить отдельные, высоконагруженные функции системы в микросервисы, что с одной стороны сэкономит ресурсы разработки, с другой, решит проблемы с нагрузкой. В перспективе, нам потребуется наблюдать за этими **высоконагруженными** микросервисами, здесь нам и потребуется USE.

Метрики:

    Utilization (утилизация) — это среднее время, которое ресурс занят работой. Измеряется в процентах.
    Saturation (насыщенность) — объём работы, которую ресурс не может выполнить и вынужден откладывать (например, в очередь), чтобы сохранять работоспособность. Насыщенность можно измерить как длину очереди.
    Errors (ошибки) — количество ошибок.

Инструменты: Prometheus, Grafana, OpenTelemetry, Elastic Stack

# Метрики


1. Метрики которые явно помогают отловить инцедент (Number of HTTP 500) - Показывает количество критических ошибок, возникающих при обработке запросов, что может указывать на проблемы в работе сервиса.

**Number of HTTP 500 for shop API**
Количество внутренних ошибок сервера (код 500) для API интернет-магазина. 

**Number of HTTP 500 for CRM API**
Количество внутренних ошибок сервера (код 500) для CRM API. 

**Number of HTTP 500 for MES API**
Количество внутренних ошибок сервера (код 500) для MES API. 

**Number of HTTP 500 for shop API**
Количество внутренних ошибок сервера (код 500) для API интернет-магазина. 

**Number of dead-letter-exchange letters in RabbitMQ**
Количество сообщений, которые не были доставлены получателям и попали в dead-letter-exchange. Помогает отслеживать проблемы с обработкой сообщений.


2. Метрики предвестники проблем

**Number of message in flight in RabbitMQ**
Количество сообщений, которые в данный момент находятся в процессе обработки в RabbitMQ. Показывает текущую нагрузку на систему сообщений.

**CPU % for shop API**
Процент использования центрального процессора API интернет-магазина. Показывает нагрузку на вычислительные ресурсы сервиса.

**CPU % for CRM API**
Процент использования центрального процессора CRM API. Измеряет загрузку CPU CRM-системы.

**CPU % for MES API**
Процент использования центрального процессора MES API. Отслеживает нагрузку на производственную систему.

**Memory Utilisation for shop API**
Использование памяти API интернет-магазина. Показывает, сколько оперативной памяти потребляет сервис.

**Memory Utilisation for CRM API**
Использование памяти CRM API. Измеряет потребление оперативной памяти CRM-системой.

**Memory Utilisation for MES API**
Использование памяти MES API. Отслеживает потребление оперативной памяти производственной системой.

**Memory Utilisation for shop db instance**
Использование памяти экземпляра базы данных интернет-магазина. Контролирует потребление памяти БД.

**Memory Utilisation for MES db instance**
Использование памяти экземпляра базы данных MES. Показывает нагрузку на БД производственной системы.

**Response time (latency) for shop API**
Время отклика API интернет-магазина. Показывает скорость обработки запросов.

**Response time (latency) for CRM API**
Время отклика CRM API. Измеряет скорость обработки запросов CRM-системой.

**Response time (latency) for MES API**
Время отклика MES API. Отслеживает скорость обработки запросов производственной системой.

**Number of message in flight in RabbitMQ**
Количество сообщений, которые в данный момент находятся в процессе обработки в RabbitMQ. Показывает текущую нагрузку на систему сообщений.

## Почему именно они

Я целюсь в обнаружение ошибок и поиск пергруженных серверов, то есть рассчитываю раскрутить цепочку - увеличение нагрузки на какой то сервер, и момент появления ошибок 500, либо повышение нагрузки и увеличение времени ответа.

Беру в расчет то что мы не знаем истинную причину возникновения текущих проблем.

# План действий

## 1. Проверка гипотез. Создание системы трассировки, логирования и мониторинга

1. Развернуть Prometheus для хранения метрик
2. Развернуть Grafana / настроить дашборды
3. Внедрить OpenTelemetry. Организовать сбор метрик с API и бэкенд-сервисов.
4. Внедряем Elastic Stack, он поможет с анализом инцедентов
5. Желательно внедрить систему нотификаций на отклонения от допустимых значений

## 2. Произвести комплексный анализ технического решения с разбором инцедентов

1. Выбрать интервал времени для разбора
2. Определить критерии по метрикам
3. Сформировать список причинно следственных связей по инцедентам

## 3. Проектирование и защита архитектуры будущего технического решения

1. Выделить проблемы, декомпозировать приложения на микросервисы, выносим только высаконагруженные функции
2. Обязательно закладываем возможности горизонтального масштабирования, микросервисы должны иметь свою личную базу данных
3. Определяем точки для кэширования (вероятно это будет кэширование запросов сайта, а также MES API)
4. Определяем Backpressure на границе высоконагруженных микросервисов

## 4. Реализуем архитектуру на практике